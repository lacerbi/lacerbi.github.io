<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.3.4">Jekyll</generator><link href="https://lacerbi.github.io/feed.xml" rel="self" type="application/atom+xml"/><link href="https://lacerbi.github.io/" rel="alternate" type="text/html" hreflang="en"/><updated>2024-12-06T12:06:19+00:00</updated><id>https://lacerbi.github.io/feed.xml</id><title type="html">blank</title><subtitle>Luigi Acerbi&apos;s personal webpage. </subtitle><entry><title type="html">Variational inference is Bayesian inference is optimization</title><link href="https://lacerbi.github.io/blog/2024/vi-is-inference-is-optimization/" rel="alternate" type="text/html" title="Variational inference is Bayesian inference is optimization"/><published>2024-12-04T00:00:00+00:00</published><updated>2024-12-04T00:00:00+00:00</updated><id>https://lacerbi.github.io/blog/2024/vi-is-inference-is-optimization</id><content type="html" xml:base="https://lacerbi.github.io/blog/2024/vi-is-inference-is-optimization/"><![CDATA[<p>The goal of this post is to show that variational inference is a natural way of thinking about Bayesian inference and not some shady approximate method.<d-footnote>Unlike what the MCMC mafia wants you to think.</d-footnote> At the end, you will be able to play around with variational inference via an interactive visualization. In fact, you can also just skip the article and go straight to play with the <a href="https://lacerbi.github.io/blog/2024/vi-is-inference-is-optimization/#playing-with-variational-inference">interactive thingie at the bottom</a>, and then come back if you feel like it.</p> <h2 id="what-is-variational-inference">What is variational inference?</h2> <p>Let’s start with the textbook definitions. We have a <em>target</em> distribution</p> \[p^\star(\theta) = \frac{\widetilde{p}(\theta)}{\mathcal{Z}},\] <p>which we know up to its normalization constant \(\mathcal{Z}\). At the core, variational inference is a way to approximate \(p^\star(\theta)\) having only the ability to evaluate the <em>unnormalized</em> target \(\widetilde{p}(\theta)\). The target can be continuous or discrete (or mixed), there are no restrictions!</p> <p>If we go on reading a textbook, it will tell us that variational inference “approximates” the target with a (simpler) distribution \(q_\psi(\theta)\) parameterized by \(\psi\).</p> <p>For example, if \(q\) is a multivariate normal, \(\psi\) could be the mean and covariance matrix of the distribution, \(\psi = (\mu, \Sigma)\). Please note that while normal distributions are a common choice in variational inference, they are not the only one – you could choose \(q\) to be <em>any</em> distribution family of your choice!</p> <h3 id="why-do-we-need-to-approximate-the-target">Why do we need to approximate the target?</h3> <p>That is a great question. Why can’t we just use the target as is? <em>Because we can’t.</em></p> <p>Yes, we may be able to evaluate \(\widetilde{p}(\theta)\) for any chosen value of \(\theta\), but that alone does not tell us much.<d-footnote>Even knowing the normalization constant might not help that much.</d-footnote> What is the shape of this distribution? What are its moments? Its covariance structure? Does it have multiple modes? What is the expectation of an arbitrary function \(f(\theta)\) under the target? What if $\theta$ is a vector and we want to <em>condition on</em> or <em>marginalize out</em> some values of it? We may not know nor be able to do any of that!</p> <p><em>One way</em> to compute some of these values (and not even all of them) might be to get samples from the target… but how do we get those? How do we draw samples from the target if we only know an unnormalized \(\widetilde{p}(\theta)\)?<d-footnote>Yes, one answer is MCMC (Markov Chain Monte Carlo), as surely you know thanks to the MCMC mafia. Point is, there are other answers.</d-footnote></p> <p>In short, we have our largely-unusable target and we would like to replace it with something that is easy to use and compute with for all the quantities we care about. There is an imponderable word for that: we want a distribution which is <em>tractable</em>.</p> <h3 id="making-the-intractable-tractable">Making the intractable tractable</h3> <p>This is the magic of what variational inference does: it takes an intractable target distribution and it gives back a <em>tractable</em> approximation \(q\), belonging to a class of our choice. We are using here tractable in a loose sense, meaning that we expect these minimal properties of a respectable probability distribution:</p> <ul> <li>\(q\) is normalized</li> <li>We can draw samples from \(q\)</li> <li>We can evaluate the density of \(q\) at any point</li> </ul> <p>There are more precise and nuanced definitions of tractability based on the specific type of probabilistic queries we can compute in polynomial time (e.g., marginals, conditionals, expectations, etc.), and you are encouraged to read Choi et al. (2020)<d-cite key="choi2020probabilistic"></d-cite>.</p> <h2 id="variational-inference-on-a-general-target-density">Variational inference on a general target density</h2> <p>So, how does \(q\) approximate the target? Intuitively, we want \(q\) to be as similar as possible to the <em>normalized</em> target \(p^\star\).</p> <p>So we can take a measure of discrepancy between two distributions, and say that we want that discrepancy to be as small as possible. Traditionally, variational inference chooses the reverse <a href="https://en.wikipedia.org/wiki/Kullback%E2%80%93Leibler_divergence">Kullback-Leibler (KL) divergence</a> as its discrepancy function:<d-footnote>For concreteness, we write the following equations as integrals, but more generally they should be written as expectations (where the notation works for discrete, continuous, and mixed distributions).</d-footnote></p> \[\text{KL}(q_\psi(\theta) \,\mid\mid\, p^\star(\theta)) = \int q_\psi(\theta) \log \frac{q_\psi(\theta)}{p^\star(\theta)} \, d\theta\] <p>This measures how the approximation \(q_\psi(\theta)\) diverges (differs) from the normalized target distribution \(p^\star(\theta)\). It is <em>reverse</em> because we put the approximation \(q\) first (the KL is not symmetric). The <em>direct</em> KL divergence would have the “real” target distribution \(p^\star\) first.</p> <p>So for a given family of approximating distributions \(q_\psi(\theta)\), variational inference chooses the best value of the parameters \(\psi\) that make \(q_\psi\) “as close as possible” to \(p^\star\) by minimizing the KL divergence between \(q_\psi\) and \(p^\star\).</p> <p>Done? Not quite yet.</p> <h3 id="the-evidence-lower-bound-elbo">The Evidence Lower BOund (ELBO)</h3> <p>There is a caveat to the logic above: remember that we only have the unnormalized \(\widetilde{p}\), we do not have \(p^\star\)! However, it turns out that this is no problem at all. First, we present the main results, and we will provide a full derivation after, for the interested readers.</p> <p>Minimizing the KL divergence between \(q_\psi\) and \(p^\star\) can be achieved by maximizing the so-called ELBO, or Evidence Lower BOund, defined as:</p> \[\text{ELBO}(q_\psi) = \underbrace{\int q_\psi(\theta) \log \widetilde{p}(\theta) \, d\theta}_{\text{Negative cross-entropy}} \; \underbrace{- \int q_\psi(\theta) \log q_\psi(\theta) \, d\theta}_{\text{Entropy}}.\] <p>First, note that the ELBO only depends on \(q_\psi\) and \(\widetilde{p}\). The ELBO takes its name because it is indeed a lower bound to the log normalization constant, that is \(\log \mathcal{Z} \ge \text{ELBO}(\psi)\).<d-footnote>The ELBO name will make even more sense as the *evidence* lower bound when we move to the context of Bayesian inference, where the normalization constant is called the *evidence*, as described later in this post.</d-footnote></p> <p>The ELBO is composed of two terms, a cross-entropy term between \(q\) and \(\widetilde{p}\) and the entropy of \(q\). The two terms represent opposing forces:</p> <ul> <li>The negative <a href="https://en.wikipedia.org/wiki/Cross-entropy">cross-entropy</a> term ensures that \(q\) avoids regions where \(p\) is low, shrinking towards high-density regions (mode-seeking behavior).</li> <li>The <a href="https://en.wikipedia.org/wiki/Entropy_(information_theory)">entropy</a> term ensures that \(q\) is as spread-out as possible.</li> </ul> <p>In conclusion, in variational inference we want to tweak the parameters \(\psi\) of \(q\) such that that the approximation \(q_\psi\) is as close as possible to \(p^\star\), according to the ELBO and, equivalently, to the KL divergence.</p> <details><summary>Expand to see the full derivation of the ELBO</summary> <p>This is the full derivation of the ELBO, courtesy of <code class="language-plaintext highlighter-rouge">o1-mini</code> and <code class="language-plaintext highlighter-rouge">gpt-4o</code>, with just a sprinkle of human magic.</p> <hr/> <h3 id="step-1-define-the-kl-divergence"><strong>Step 1: Define the KL divergence</strong></h3> <p>The reverse Kullback-Leibler (KL) divergence between \(q_\psi(\theta)\) and the normalized target \(p^\star(\theta)\) is:</p> \[\text{KL}(q_\psi(\theta) \,\mid\mid\, p^\star(\theta)) = \int q_\psi(\theta) \log \frac{q_\psi(\theta)}{p^\star(\theta)} \, d\theta\] <hr/> <h3 id="step-2-express-pstartheta-in-terms-of-widetildeptheta"><strong>Step 2: Express \(p^\star(\theta)\) in terms of \(\widetilde{p}(\theta)\)</strong></h3> <p>The normalized target \(p^\star(\theta)\) is related to the unnormalized target \(\widetilde{p}(\theta)\) through the normalization constant \(\mathcal{Z}\):</p> \[p^\star(\theta) = \frac{\widetilde{p}(\theta)}{\mathcal{Z}}, \quad \text{where} \quad \mathcal{Z} = \int \widetilde{p}(\theta) \, d\theta.\] <p>Substitute this expression for \(p^\star(\theta)\) into the KL divergence:</p> \[\text{KL}(q_\psi(\theta) \,\mid\mid\, p^\star(\theta)) = \int q_\psi(\theta) \log \left( q_\psi(\theta) \cdot \frac{\mathcal{Z}}{\widetilde{p}(\theta)} \right) \, d\theta\] <hr/> <h3 id="step-3-split-the-logarithm"><strong>Step 3: Split the logarithm</strong></h3> <p>Using the property of logarithms \(\log(ab) = \log(a) + \log(b)\), split the term inside the integral:</p> \[\text{KL}(q_\psi(\theta) \,\mid\mid\, p^\star(\theta)) = \int q_\psi(\theta) \big( \log q_\psi(\theta) + \log \mathcal{Z} - \log \widetilde{p}(\theta) \big) \, d\theta\] <hr/> <h3 id="step-4-separate-the-terms"><strong>Step 4: Separate the terms</strong></h3> <p>Distribute \(q_\psi(\theta)\) over the sum:</p> \[\text{KL}(q_\psi(\theta) \,\mid\mid\, p^\star(\theta)) = \int q_\psi(\theta) \log q_\psi(\theta) \, d\theta + \int q_\psi(\theta) \log \mathcal{Z} \, d\theta - \int q_\psi(\theta) \log \widetilde{p}(\theta) \, d\theta\] <hr/> <h3 id="step-5-simplify-the-second-term"><strong>Step 5: Simplify the second term</strong></h3> <p>Since \(\mathcal{Z}\) is a constant, \(\log \mathcal{Z}\) is also constant and can be factored out of the integral:</p> \[\int q_\psi(\theta) \log \mathcal{Z} \, d\theta = \log \mathcal{Z} \int q_\psi(\theta) \, d\theta\] <p>Because \(q_\psi(\theta)\) is a valid, normalized probability distribution, \(\int q_\psi(\theta) \, d\theta = 1\). Therefore:</p> \[\int q_\psi(\theta) \log \mathcal{Z} \, d\theta = \log \mathcal{Z}\] <p>Substitute this simplification back into the KL divergence:</p> \[\text{KL}(q_\psi(\theta) \,\mid\mid\, p^\star(\theta)) = \int q_\psi(\theta) \log q_\psi(\theta) \, d\theta + \log \mathcal{Z} - \int q_\psi(\theta) \log \widetilde{p}(\theta) \, d\theta\] <hr/> <h3 id="step-6-rearrange-terms"><strong>Step 6: Rearrange terms</strong></h3> <p>Rearrange the equation to isolate \(\log \mathcal{Z}\), grouping terms related to \(q_\psi(\theta)\):</p> \[\log \mathcal{Z} = \text{KL}(q_\psi(\theta) \,\mid\mid\, p^\star(\theta)) + \left( \int q_\psi(\theta) \log \widetilde{p}(\theta) \, d\theta - \int q_\psi(\theta) \log q_\psi(\theta) \, d\theta \right)\] <hr/> <h3 id="step-7-define-the-elbo"><strong>Step 7: Define the ELBO</strong></h3> <p>The ELBO is defined as:</p> \[\text{ELBO}(q_\psi) = \int q_\psi(\theta) \log \widetilde{p}(\theta) \, d\theta - \int q_\psi(\theta) \log q_\psi(\theta) \, d\theta\] <p>Substitute this into the equation for \(\log \mathcal{Z}\):</p> \[\log \mathcal{Z} = \text{KL}(q_\psi(\theta) \,\mid\mid\, p^\star(\theta)) + \text{ELBO}(q_\psi)\] <hr/> <h3 id="step-8-rearrange-for-the-elbo"><strong>Step 8: Rearrange for the ELBO</strong></h3> <p>Rearranging to isolate \(\text{ELBO}(q_\psi)\):</p> \[\text{ELBO}(q_\psi) = \log \mathcal{Z} - \text{KL}(q_\psi(\theta) \,\mid\mid\, p^\star(\theta))\] <hr/> <h3 id="step-9-interpretation"><strong>Step 9: Interpretation</strong></h3> <ul> <li>\(\log \mathcal{Z}\) is a constant with respect to \(q_\psi(\theta)\).</li> <li>To minimize \(\text{KL}(q_\psi(\theta) \,\mid\mid\, p^\star(\theta))\), we maximize \(\text{ELBO}(q_\psi)\).</li> </ul> <p>Thus, <strong>minimizing the KL divergence is equivalent to maximizing the ELBO</strong>.</p> <p>Moreover, since the $\text{KL}$ divergence is non-negative and zero if $p = q$:</p> <ul> <li>$\text{ELBO}(q_\psi) \le \log \mathcal{Z} \Longrightarrow$ the ELBO is a lower bound to $\log Z$.</li> <li>If $q = p$, $\text{ELBO}(q_\psi) = \log \mathcal{Z}$.</li> </ul> </details> <details><summary>Expand to see a compressed algebraic derivation of the ELBO</summary> <p>Ignoring the fact that $\widetilde{p}(\theta)$ is not normalized, we can obtain the ELBO purely algebraically.</p> <p>First, let’s (improperly) write the ELBO in terms of the KL divergence between $q$ and the unnormalized $\widetilde{p}$:</p> \[\text{ELBO}(q) = -\text{KL}(q \,\mid\mid\, \widetilde{p})\] <p>Then we have four steps:</p> <ol> <li> \[\text{KL}[q \,\mid\mid\, \widetilde{p}] = \text{KL}[q || \mathcal{Z} p^\star] = \text{KL}[q \,\mid\mid\, p^\star] - \log \mathcal{Z}\] </li> <li> \[\text{KL}[q \,\mid\mid\, p^\star] = \text{KL}[q \,\mid\mid\, p] + \log \mathcal{Z}\] </li> <li> \[\text{KL}[q \,\mid\mid\, p^\star] = \log \mathcal{Z} - \text{ELBO}(q)\] </li> <li> \[\text{ELBO}(q) = \log \mathcal{Z} - \text{KL}[q \,\mid\mid\, p^\star] &lt;= \log \mathcal{Z}\] </li> </ol> <p>The much longer “full derivation” in the tab above is to avoid using the KL divergence for an unnormalized pdf, which is improper; but it is the same thing.</p> <p>We can famously <a href="https://en.wikipedia.org/wiki/Evidence_lower_bound#Deriving_the_ELBO">derive the ELBO using Jensen’s inequality</a>, but it adds an unnecessary and potentially misleading “approximate” step, when we apply the inequality. I prefer the almost trivial derivation above, which shows the relationship between the ELBO and the KL divergence purely algebraically.</p> <p>(You still need Jensen’s to show that the KL divergence is non-negative; but subjectively that feels just a property of the KL instead of being the ELBO doing something shady.)</p> </details> <h2 id="variational-inference-for-bayesian-inference">Variational inference for Bayesian inference</h2> <p>While variational inference can be performed for any generic target density \(\widetilde{p}(\theta)\), the common scenario is that our target density is a <em>posterior distribution</em>:</p> \[{p^\star}(\theta) \equiv p(\theta \mid \mathcal{D}) = \frac{p(\mathcal{D} \mid \theta) \pi(\theta)}{p(\mathcal{D})}\] <p>where you should recognize on the right-hand side good old Bayes’ theorem, with \(p(\mathcal{D} \mid \theta)\) the <em>likelihood</em> and \(\pi(\theta)\) the <em>prior</em>.<d-footnote>We denote the prior with $\pi$ to avoid confusion with the target.</d-footnote> The normalization constant at the denominator is $\mathcal{Z} \equiv p(\mathcal{D})$, also called the <em>model evidence</em> or <em>marginal likelihood</em>. See Lotfi et al. (2022)<d-cite key="lotfi2022bayesian"></d-cite> for a recent discussion of the marginal likelihood in machine learning.</p> <p>In essentially all practical scenarios we never know the normalization constant, but we can instead compute the <em>unnormalized</em> posterior:</p> \[\widetilde{p}(\theta) = p(\mathcal{D} \mid \theta) \pi(\theta).\] <p>In this typical usage-case scenario for variational inference, the ELBO reads:</p> \[\text{ELBO}(q_\psi) = \mathbb{E}_{q_\psi(\theta)}\left[ \log p(\mathcal{D} \mid \theta) \pi(\theta) \right] - \mathbb{E}_{q_\psi(\theta)}\left[\log q_\psi(\theta)\right]\] <p>where we simply replaced \(\widetilde{p}\) with the unnormalized posterior, and we switched here to the expectation notation, instead of integrals, just to show you how that would look like.</p> <h2 id="variational-inference-is-just-optimization">Variational inference is just optimization</h2> <p>In conclusion, variational inference reduces Bayesian inference to an optimization problem. You have a candidate solution $q$, and you shake it and twist it and spread it around until you maximize the ELBO. Variational inference per se is nothing more than this.<d-footnote>There are also variational inference methods that use other divergences than the reverse KL divergence, but we lose the meaning of the ELBO as a lower bound to the log normalization constant.</d-footnote></p> <p>You may have seen other introductions to or formulations of variational inference that may seem way more complicated. The point is that most variational inference <em>algorithms</em> focus on:</p> <ul> <li>Specific families of $q$ (e.g., factorized, exponential families, etc.)</li> <li>Specific ways of calculating and optimizing the ELBO (block-wise coordinate updates, stochastic gradient ascent, etc.)</li> </ul> <p>But don’t get confused: these are all <em>implementation details</em>. To reiterate, in principle you can just compute the expectation in the ELBO however you want and however it is convenient for you (e.g., by numerical integration, as we will do below), and move things around such that you maximize the ELBO. There is nothing more to it.</p> <p>Of course, there are many clever things that can be done in various special cases (including exploiting <a href="https://en.wikipedia.org/wiki/Calculus_of_variations">variational calculus</a>, hence the name), but none of those are necessary to understand variational inference. See Blei et al. (2017)<d-cite key="blei2017variational"></d-cite> for a review of various approaches.</p> <h3 id="variational-inference-is-just-inference">Variational inference is just inference</h3> <p>For the reasons mentioned above, I believe that variational inference is possibly the most natural way of thinking about Bayesian inference: computing the posterior is not some esoteric procedure, but we are just trying to find the distribution that best matches the true target posterior, which we know up to a constant.</p> <p>Variational inference is often seen as “just an approximation method” – as opposed to a true technique for performing Bayesian inference – because historically we were forced to use very simple approximation families (factorized, simple Gaussians, etc.). However, it has been a while since we can use very flexible distributions, starting for example from the advent of normalizing flows in the 2010s. See the poignant review paper by Papamakarios et al. (2021).<d-cite key="papamakarios2021normalizing"></d-cite></p> <p>But even old-school distributions such as mixtures of Gaussians can go a long way, as long as you use enough components; the difficulty there is to fit them accurately. <em>For example</em>,<d-footnote>Self-promotion alert!</d-footnote> our sample-efficient <a href="https://acerbilab.github.io/pyvbmc/">Variational Bayesian Monte Carlo method</a> uses a mixture of Gaussians with <em>many</em> components (up to 50) to achieve pretty-good approximations of the target. We can do that reliably and efficiently because we exploit a Gaussian process approximation of the log target which lets us calculate the cross-entropy term of the ELBO <em>analytically</em>, thus yielding very accurate gradients. I will probably write a separate post on this, and more details in Acerbi (2018, 2020).<d-cite key="acerbi2018variational"></d-cite><d-cite key="acerbi2020variational"></d-cite></p> <h2 id="playing-with-variational-inference">Playing with variational inference</h2> <p>In the widget below (<a href="https://lacerbi.github.io/interactive-vi-demo/">app page</a>) you can see variational inference at work for yourself. This works best on a computer, some aspects are not ideal on mobile.</p> <p>You can select the target density as well as the family of variational posterior, from a single Gaussian with different constraints (isotropic, diagonal covariance, full covariance) to various mixtures of Gaussians.</p> <p>Your job: click and drag around the distributions and change their parameters – or just lazily press <em>Optimize</em> – and see the ELBO value go up, getting closer and closer to the true \(\log \mathcal{Z}\), as far as the chosen posterior family allows.</p> <p>It is very satisfying.</p> <iframe src="https://lacerbi.github.io/interactive-vi-demo/" width="100%" height="740px" style="border: none; margin-bottom: 40px;" title="Interactive Variational Inference Demo"> </iframe> <p>In the widget above, the ELBO is calculated via numerical integration on a grid centered around each Gaussian component, and the gradient used for optimization is calculated via <a href="https://en.wikipedia.org/wiki/Finite_difference">finite differences</a>. That’s it, nothing fancy.</p> <p>Incidentally, I spent way too much time coding up this widget, even with the help of Claude. Still, I am pretty happy with the result given that I knew zero JavaScript when I started; and I would not have done it if I had to learn JavaScript just for this. I will probably write a blog post about the process at some point.</p> <blockquote> <p>I will be hiring postdocs in early 2025 to work on extending Variational Bayesian Monte Carlo<d-cite key="acerbi2018variational"></d-cite><d-cite key="acerbi2020variational"></d-cite> and related topics. If interested, please get in touch – we can also meet at NeurIPS in Vancouver!</p> </blockquote>]]></content><author><name>Luigi Acerbi</name></author><category term="variational-inference"/><category term="demos"/><summary type="html"><![CDATA[my take on variational inference with an interactive demo]]></summary></entry><entry><title type="html">Hello world</title><link href="https://lacerbi.github.io/blog/2024/hello-world/" rel="alternate" type="text/html" title="Hello world"/><published>2024-11-21T10:32:13+00:00</published><updated>2024-11-21T10:32:13+00:00</updated><id>https://lacerbi.github.io/blog/2024/hello-world</id><content type="html" xml:base="https://lacerbi.github.io/blog/2024/hello-world/"><![CDATA[<h2 id="hello-world">Hello World</h2> <p>This is just a test of the new website blog.</p>]]></content><author><name></name></author><category term="sample-posts"/><category term="hellos"/><category term="worlds"/><summary type="html"><![CDATA[Just a test post.]]></summary></entry></feed>